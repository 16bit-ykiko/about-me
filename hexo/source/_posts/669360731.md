---
title: '使用 clang 工具自由的支配 C++ 代码吧！'
date: 2023-11-29 01:14:27
updated: 2024-03-17 07:12:00
type: 'post'
cover: 'https://picx.zhimg.com/v2-65620f7f45f8ee4b2e13c88db8f27b42_720w.jpg?source=172ae18b'
---


clang 是一个由 LLVM 项目提供的 C 语言家族的编译器前端。它最初是为了替代 GNU Compiler Collection (GCC) 的 C 语言前端而开发的。clang 的目标是提供更快的编译速度、更好的诊断信息和更灵活的架构。clang 包括一个 C、C++ 和 Objective-C 编译器的前端，它们被设计成可嵌入到其他项目中。clang 的一个重要特点是其 modularity（模块化）架构，这使得开发者可以更容易地扩展和定制编译器的功能。它也被广泛用于许多项目中，包括 LLVM 自身、一些操作系统的内核开发，以及一些编程语言的编译器实现。

除了作为编译器使用之外，clang 还可以作为一个库提供，使开发者能够在其应用程序中利用编译器的功能，例如源代码分析和生成。没错！clang 还可以作为一个库提供，我们可以用 clang 来获取 C++ 源文件的 AST，以便于我们进一步处理这些信息。本文就是对如何使用 clang 工具的一篇介绍

## 安装 & 使用

目前 clang 被划分为以下库和工具：

- libsupport 
- libsystem 
- libbasic 
- libast 
- liblex 
- libparse 
- libsema 
- libcodegen 
- librewrite 
- libanalysis 


由于 clang 本身是用 C++ 编写的，所以相关的接口都是 C++ 的。然而由于 C++ 接口内容本身的复杂性，以及不稳定性（例如在 Windows 上由 gcc 编译出来的 dll，没法给 msvc 用，又或者 clang 自身版本升级，导致原来的 API 变动从而出现不兼容性），所以官方并不推荐我们首选 C++ 接口来使用。除了 C++ 接口之外，官方还提供了一个叫做 libclang 的 C 语言 [接口](https://clang.llvm.org/doxygen/group__CINDEX.html)，这个接口不仅使用起来相对简单，而且本身也是比较稳定的。唯一的缺点是没法获取完整的 C++ 的 AST，不过鉴于 C++ 完整的语法树本身就极度复杂，很多时候我们只需要一部分就好了，所以这个问题完全可以忽略，除非你真的有这方面需求。

如果你想要使用 libclang，你需要先安装 llvm 和 clang，[这里](https://github.com/llvm/llvm-project/releases) 有若干预发布的二进制包可以下载。如果你需要定制化的需求，请参考这个 [页面](https://llvm.org/docs/GettingStarted.html#id4) 尝试手动进行编译。安装完成之后只需要把 llvm/lib 目录下的 libclang.dll 链接到程序，然后包含 llvm/include 目录下的 clang-c/Index.h 头文件即可使用。

然而，由于 C 语言没有高级的一些抽象，操作个字符串都麻烦。如果想要实际使用，还得我们自己用 C++ 封装一下，还好官方基于这套 C 接口还提供了一个 py bind，也就是这个 [包](https://pypi.org/project/clang/)，这样的话用起来就比较方便了。不过官方提供的 py bind 并没有打包 libclang 的这个 dll，也就是你还得在电脑上手动配置环境。这很让人讨厌，不过还好社区有人提供了打包好的 [版本](https://pypi.org/project/libclang/)。

于是如果你想使用 libclang 来获取 C++ 语法树，只需要

```bash
pip install libclang
```

什么额外的事情都不用做。本文就基于这个 py bind 的版本进行介绍，C 版本的 API 和 Python 版本的 API 基本是完全一致的。如果你觉得 Python 性能不够，你也可以参考这个教程对照写 C 版本的代码即可。另外官方提供的包并没有 type hint，这样的话用 Python 写就没有代码补全，用起来也不舒服。我自己补了一个类型提示的 [文件](https://github.com/16bit-ykiko/clang-related/blob/main/cindex.pyi)，下载下来之后直接和  放在同一文件夹内就能有代码提示了。

## 入门案例

示例的 C++ 源文件代码如下

```cpp
// main.cpp
struct Person
{
    int age;
    const char* name;
};

int main()
{
    Person person = { 1, "John" }; 
    return 0;
}
```

解析它的 Python 代码如下

```python
import clang.cindex as C
```