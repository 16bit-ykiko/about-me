---
title: '各种姿势进行代码生成'
date: 2023-11-29 01:14:16
updated: 2023-12-30 20:34:19
type: 'post'
cover: 'https://picx.zhimg.com/v2-effe29ad4d276f5fe1b0eda7b8a598e4_720w.jpg?source=172ae18b'
---


## 引入

刚好拿最近的一个需求作为引入吧。我们都知道`markdown`可以用`[```lang```]`来填入代码块，并支持代码高亮。可是我想支持自己定义的代码高亮规则，遇到了如下问题：

- 有些网站对`markdown`渲染是静态的，不能运行脚本，所以没法直接调用那些`js`的代码高亮库。例如`Github`上面对`markdown`文件的渲染
- 究竟支持哪些语言一般是由渲染引擎决定的，比如`github`的渲染支持和`vscode`的所支持的就不同。如果要针对不同的渲染引擎写扩展，每个都得写一份，工作量太大了，而且相关的资料很少


那真就没有办法了吗？唉，办法还是有的，幸好大多数引擎都支持直接用`html`的规则，比如`<code>`来进行渲染

```html
<code style= "color: #5C6370;font-style: italic;">
# this a variable named &#x27;a&#x27;
</code>
```

这为我们添加自定义样式提供了可能。但是我们写`markdown`的源文件不能手写这种代码的啊。如果一个语句有三种不同颜色，如果是`let a = 3;`这样的语句，意味着光一句话我们就得写三个不同的`<span>`。非常难写，后面维护起来也不好维护，

事实上我们可以这么做，读取`markdown`的源文件，源文件就按照正常的`markdown`语法写，然后我们在读取的时候，遇到`[```lang```]`的时候，把文本提取出来，然后交给负责渲染的库渲染成`dom`文本，我选择的是`highlight.js`这个库。然后把原来的文本替换掉，单独输出在新的文件夹里，比如原来的叫文件夹叫`src`，新的叫`out`。这样的话源文件不需要任何修改，然后实际渲染的是`out`文件夹里面的内容就好了。每次我们更改完源文件，运行一下这个程序做一下转换就行了。

## 什么是Code Generation

其实上面的案例就是一个典型的使用『代码生成』也即`code generation`解来决问题的案例。那究竟什么是代码生成呢？这其实也是一个含义相当广泛的词汇。一般来说

>  代码生成是指是指通过使用计算机程序来生成其他程序或代码的过程

包括但不限于： 

- 编译器生成目标代码： 这是最典型的例子，其中编译器将高级编程语言的源代码翻译成机器可执行的目标代码
-  使用配置文件或`DSL`生成代码：通过特定的配置文件或领域特定语言（DSL），生成实际的代码。一个示例是使用`XML`配置文件来定义`UI`界面，然后生成相应的代码 
- 语言内建特性生成代码： 一些编程语言具有内建的特性，如宏、泛型等，可以在编译时或运行时生成代码。这样的机制可以提高代码的灵活性和重用性。 
- 外部代码生成器： 某些框架或库使用外部代码生成器来创建所需的代码。例如，Qt框架使用元对象编译器（MOC）来处理元对象系统，生成与信号和槽相关的代码。


下面就这几点来举一些具体的例子：

## 编译时代码生成

#### 宏

`C`语言的`marco`就是一种最经典，也最简单的编译期代码生成技术。纯文本替换，比如我们想重复`"Hello World"`这个字符串`100`次。那怎么办呢？显然我们不想手动粘贴复制。考虑使用宏来完成这个工作

```c
#define REPEAT(x) (REPEAT1(x) REPEAT1(x) REPEAT1(x) REPEAT1(x) REPEAT1(x))
#define REPEAT1(x) REPEAT2(x) REPEAT2(x) REPEAT2(x) REPEAT2(x) REPEAT2(x)
#define REPEAT2(x) x x x x

int main()
{
    const char* str = REPEAT("Hello world ");
}
```

这里主要运用了`C`语言中的一个特性就是`"a""b"`等价于`"ab"`。然后通过宏展开`5*5*4`刚好一百次，然后就轻松的完成了这个任务。 当然了`C`语言的宏由于其本质上只是`Token`替换，而且不允许使用者获取`Token`流进行输入分析，所以功能十分有限。尽管如此，还是有一些比较有意思的用法的。感兴趣的可以阅读下这篇文